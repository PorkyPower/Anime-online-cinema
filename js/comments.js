$("body").on("paste",function(t){"inputtext"==$(":focus").attr("id")&&(t.preventDefault(),t=t.originalEvent.clipboardData.getData("text"),document.execCommand("inserttext",!1,t))});var sendtext="",sendidreply=0,senduserreply=0;$("body").on("keydown",function(t){if(13==t.keyCode&&!t.shiftKey&&(senduserreply=sendidreply=0,"inputtext"==$(":focus").attr("id")))return sendtext=$(":focus").html(),"text"==$(":focus").attr("reply")&&(sendidreply=$(":focus").parents("#comms-form").attr("form_id"),senduserreply=$(":focus").parent().children("#reply_id_comm").attr("value"),$("div[reply_form=on]")[0].outerHTML=""),$(":focus").html(""),t.preventDefault(),sendcomm(),!1});var sendid=0,ratval="";function sendrating(){$.ajax({url:"http://"+window.location.host+"/api/sendratingcomm",method:"post",dataType:"html",data:{token:infouser.token,path:location.pathname,sendid:sendid,rating:ratval},success:function(t){}})}function sendcomm(){$.ajax({url:"http://"+window.location.host+"/api/sendcomm",method:"post",dataType:"html",data:{token:infouser.token,path:location.pathname,sendtext:sendtext,sendidreply:sendidreply,senduserreply:senduserreply},success:function(t){}})}$(document).on("click","#rating_up",function(){sendid=$(this).parents("[id_comm]").attr("id_comm"),ratval="up",sendrating()}),$(document).on("click","#rating_down",function(){sendid=$(this).parents("[id_comm]").attr("id_comm"),ratval="down",sendrating()}),$(document).on("click","#sendcom",function(){return senduserreply=sendidreply=0,sendtext=$(this).parents("[id=comms-form]").children().children("#inputtext").html(),"on"==$(this).parents("[id=comms-form]").attr("reply_form")&&(sendidreply=$(this).parents("[id=comms-form]").attr("form_id"),senduserreply=$(this).parents("[id=comms-form]").children().children('[id="reply_id_comm"]').attr("value")),sendcomm(),!1}),$(function(){loadcomments(),null==infouser.id&&($("#comms-form").css("height","5%"),$("#comms-form").html("Доступно только авторизованным!"));setInterval(()=>loadcomments(),1500)});var reply_name="",idrepl="",namerepl="",id_reply_comm="";function loadcomments(){$.ajax({url:"http://"+window.location.host+"/api/getcomms",method:"post",dataType:"json",data:{token:infouser.token,path:location.pathname},success:function(t){for(var e=0;e<t.items.length;e++){var i=new Date,d=new Date(1e3*t.items[e].date),r="";if(r=i.getFullYear()===d.getFullYear()&&i.getMonth()===d.getMonth()&&i.getDate()===d.getDate()?"Сегодня в "+d.getHours()+":"+d.getMinutes():i.getFullYear()===d.getFullYear()&&i.getMonth()===d.getMonth()&&i.getDate()-1===d.getDate()?"Вчера в "+d.getHours()+":"+d.getMinutes():d.getDate()+"."+(d.getMonth()+1)+" "+d.getHours()+":"+d.getMinutes(),$("div[id_comm="+t.items[e].id+"]").length<1&&($("#cooms-count").html("Комментарии "+t.count),$("#comms-list").append("<div id_comm="+t.items[e].id+" author_id="+t.items[e].iduser+" author_name="+t.items[e].name+" id=comm><div id=comm_head><div typecomm=comm id=comm_author_name><div id=comm_author_avatar_outline><div id=comm_author_avatar style=background:url(http://SITE/imgs/users/ava/"+t.items[e].avatar_user+')></div></div><a target="_blank" href="./id'+t.items[e].iduser+'">'+t.items[e].name+"</a></div><div id=comm_date>"+r+'</div><div id=comm_rating><div id=rating_up><svg width="12" height="12" viewBox="0 0 117 122" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58.5064 115.345V7.03797M58.5064 7.03797L110.494 59.0253M58.5064 7.03797L6.51901 59.0253" stroke="lime" stroke-width="12.9968" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id=count_rating>'+t.items[e].rating+'</div><div id=rating_down><svg width="12" height="12" viewBox="0 0 117 122" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58.5064 7.03797V115.345M58.5064 115.345L6.51901 63.3576M58.5064 115.345L110.494 63.3576" stroke="red" stroke-width="12.9968" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div><div id=comm_cont>'+t.items[e].text+"</div><div id=reply_comm>Ответить</div></div>")),void 0!==t.items[e].thead){$("div[replay_comm="+t.items[e].id+"]").length<1&&$("#comms-list").append("<div replay_comm="+t.items[e].id+" id=child-comments></div>");for(var o=0;o<t.items[e].thead.length;o++){i=new Date,d=new Date(1e3*t.items[e].thead[o].date),r="";r=i.getFullYear()===d.getFullYear()&&i.getMonth()===d.getMonth()&&i.getDate()===d.getDate()?"Сегодня в "+d.getHours()+":"+d.getMinutes():i.getFullYear()===d.getFullYear()&&i.getMonth()===d.getMonth()&&i.getDate()-1===d.getDate()?"Вчера в "+d.getHours()+":"+d.getMinutes():d.getDate()+"."+(d.getMonth()+1)+" "+d.getHours()+":"+d.getMinutes(),$("div[id_comm="+t.items[e].thead[o].id+"]").length<1&&($("#cooms-count").html("Комментарии "+t.count),$("div[replay_comm="+t.items[e].id+"]").append("<div id_comm="+t.items[e].thead[o].id+" typecomm=reply_comm author_name="+t.items[e].thead[o].name+" author_id="+t.items[e].thead[o].iduser+" id=reply_comment><div id=comm_head><div id=comm_author_name><div id=comm_author_avatar_outline><div id=comm_author_avatar style=background:url(http://SITE/imgs/users/ava/"+t.items[e].thead[o].avatar_user+')></div></div><a target="_blank" href="./id'+t.items[e].thead[o].iduser+'">'+t.items[e].thead[o].name+"</a></div><div id=comm_date>"+r+'</div><div id=comm_rating><div id=rating_up><svg width="12" height="12" viewBox="0 0 117 122" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58.5064 115.345V7.03797M58.5064 7.03797L110.494 59.0253M58.5064 7.03797L6.51901 59.0253" stroke="lime" stroke-width="12.9968" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div id=count_rating>'+t.items[e].thead[o].rating+'</div><div id=rating_down><svg width="12" height="12" viewBox="0 0 117 122" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58.5064 7.03797V115.345M58.5064 115.345L6.51901 63.3576M58.5064 115.345L110.494 63.3576" stroke="red" stroke-width="12.9968" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div><div id=comm_cont>'+t.items[e].thead[o].text+"</div><div id=reply_comm>Ответить</div></div>"))}}}}})}$(document).on("click","#reply_comm",function(){if(null!=infouser.id)if($(this).parents("div[typecomm=reply_comm]").length||$("[replay_comm="+$(this).parent().attr("id_comm")+"]").length){if(form_id=void 0!==$(this).parents("div[id=comm]").attr("id_comm")?$(this).parents("div[id=comm]").attr("id_comm"):$(this).parents("div[id=child-comments]").attr("replay_comm"),$("div[reply_form=on]").length&&($("div[reply_form=on]")[0].outerHTML=""),$("div[reply_form=on][form_id="+form_id+"]").length){$("div[form_id="+form_id+"]").children("#reply_id_comm").attr("idreply")!=id_reply_comm&&(reply_text=$("[idreply="+id_reply_comm+"]").parent().children("div#inputtext").html(),reply_text=reply_text.replace(namerepl+",",$(this).parent().attr("author_name")+","),""==reply_text&&(reply_text=$(this).parent().attr("author_name")+","),$("[idreply="+id_reply_comm+"]").parent().children("div#inputtext").html(reply_text),$("[idreply="+id_reply_comm+"]").attr("idreply",$(this).parent().attr("id_comm"))),id_reply_comm=void 0!==$(this).parents("div[id=comm]").attr("id_comm")?(form_id=$(this).parents("div[id=comm]").attr("id_comm"),idrepl=$("[id_comm="+form_id+"]").attr("author_id"),namerepl=$("[id_comm="+form_id+"]").attr("author_name"),$("[id_comm="+form_id+"]").attr("id_comm")):(idrepl=$(this).parent().attr("author_id"),namerepl=$(this).parent().attr("author_name"),$(this).parent().attr("id_comm")),$("[idreply="+id_reply_comm+"]").attr("value",idrepl),$("div[reply_form=on][form_id="+form_id+"]").children().children("#inputtext").get(0).focus();let t=window.getSelection();return t.selectAllChildren($("div[reply_form=on][form_id="+form_id+"]").children().children("#inputtext").get(0)),void t.collapseToEnd()}id_reply_comm=void 0!==$(this).parents("div[id=comm]").attr("id_comm")?(form_id=$(this).parents("div[id=comm]").attr("id_comm"),idrepl=$("[id_comm="+form_id+"]").attr("author_id"),namerepl=$("[id_comm="+form_id+"]").attr("author_name"),$("[id_comm="+form_id+"]").attr("id_comm")):(form_id=$(this).parents("div[id=child-comments]").attr("replay_comm"),idrepl=$(this).parent().attr("author_id"),namerepl=$(this).parent().attr("author_name"),$(this).parent().attr("id_comm")),sendform="<div reply_form=on form_id="+form_id+' id="comms-form"><div><input id="reply_id_comm" idreply='+id_reply_comm+' type="text" hidden="" value='+idrepl+'><div id="inputtext" reply=text placeholder="Напишите комментарий" contenteditable="true">'+namerepl+',&nbsp;</div></div><div><div id=sendcom><svg width="24" height="24" viewBox="0 0 124 106" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M119.055 52.785L4.97217 100.82L26.3628 52.785L4.97217 4.74994L119.055 52.785Z" stroke="white" stroke-width="9.00658" stroke-linecap="round" stroke-linejoin="round"/><path d="M25.9875 52.785H119.056" stroke="white" stroke-width="9.00658" stroke-linecap="round" stroke-linejoin="round"/></svg></div></div></div>',("comm"==$(this).parent().attr("id")?$("[replay_comm="+$(this).parent().attr("id_comm")+"]"):$(this).parents("#child-comments")).append(sendform),$("[reply]").html(),$("div[reply_form=on][form_id="+form_id+"]").children().children("#inputtext").get(0).focus();let t=window.getSelection();t.selectAllChildren($("div[reply_form=on][form_id="+form_id+"]").children().children("#inputtext").get(0)),t.collapseToEnd()}else{id_comm=$(this).parent().attr("id_comm");var t='<div replay_comm="'+id_comm+'" id="child-comments"></div>';$(this).parent()[0].outerHTML=$(this).parent()[0].outerHTML+t,$("[id_comm="+id_comm+"]").children("#reply_comm").trigger("click")}});